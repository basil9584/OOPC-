using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;

namespace OnlineQuizSystem
{
    public class QuizSystem
    {
        // Lists to hold system data
        private List<Admin> admins;
        private List<Student> students;
        private List<Quiz> quizzes;
        private List<Category> categories;

        // Constructor
        public QuizSystem()
        {
            admins = new List<Admin>();
            students = new List<Student>();
            quizzes = new List<Quiz>();
            categories = new List<Category>();
        }

        // --- Task 2: Data Loading (Page 5, 8, 9) ---
        public void LoadSampleData()
        {
            // Create Admin
            admins.Add(new Admin(1, "admin", "admin123", "admin@ulster.ac.uk", DateTime.Now));

            // Create Sample Students
            students.Add(new Student(101, "student1", "pass1", "s1@ulster.ac.uk", "active"));
            students.Add(new Student(102, "student2", "pass2", "s2@ulster.ac.uk", "inactive"));

            // Create Categories (Page 7)
            Category catProg = new Category(1, "Programming Concepts", "Concepts of OOP and coding");
            Category catData = new Category(2, "Data Structures", "Arrays, lists, stacks, queues");
            categories.Add(catProg);
            categories.Add(catData);
            categories.Add(new Category(3, "Software Design", "Patterns and architecture"));

            // Create Quiz (Page 8)
            Quiz oopQuiz = new Quiz(1, "OOP Fundamentals", "Covers basics of object-oriented programming", catProg, DateTime.Parse("01/09/2025"));

            // Create Questions (Page 9) - Adding sample 3 for brevity, real app would have all 10
            oopQuiz.AddQuestion(new Question(1, "What does OOP stand for?", 
                new List<string> { "Object-Oriented Programming", "Open Order Protocol", "Overloaded Operator" }, 
                "Object-Oriented Programming", "Easy"));
            
            oopQuiz.AddQuestion(new Question(2, "Which is NOT a core principle of OOP?", 
                new List<string> { "Encapsulation", "Polymorphism", "Compilation" }, 
                "Compilation", "Easy"));

            oopQuiz.AddQuestion(new Question(3, "What is encapsulation?",
               new List<string> { "Binding data and methods", "Inheritance", "Creating objects" },
               "Binding data and methods", "Medium"));
            
            oopQuiz.AddQuestion(new Question(4, "Keyword to inherit in C#?",
               new List<string> { "extends", ":", "implements" },
               ":", "Medium"));

            quizzes.Add(oopQuiz);
        }

        // --- Task 2: User Interface / Controlling Application ---
        public void ShowMainMenu()
        {
            bool running = true;
            while (running)
            {
                Console.Clear();
                Console.WriteLine("=== Ulster University Online Quiz System ===");
                Console.WriteLine("1. Admin Menu");
                Console.WriteLine("2. Student Menu (Play Quiz)");
                Console.WriteLine("3. Exit");
                Console.Write("Enter choice: ");

                try
                {
                    string input = Console.ReadLine();
                    int choice = int.Parse(input);

                    switch (choice)
                    {
                        case 1:
                            if (AuthenticateAdmin())
                            {
                                ShowAdminMenu();
                            }
                            break;
                        case 2:
                            ShowStudentMenu();
                            break;
                        case 3:
                            Exit();
                            running = false;
                            break;
                        default:
                            Console.WriteLine("Invalid option. Press Enter to try again.");
                            Console.ReadLine();
                            break;
                    }
                }
                catch (FormatException)
                {
                    Console.WriteLine("Error: Please enter a valid number.");
                    Console.ReadLine();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"An unexpected error occurred: {ex.Message}");
                    Console.ReadLine();
                }
            }
        }

        public bool AuthenticateAdmin()
        {
            Console.Clear();
            Console.WriteLine("--- Admin Login ---");
            Console.Write("Enter Username: ");
            string u = Console.ReadLine();
            Console.Write("Enter Password: ");
            string p = Console.ReadLine();

            foreach (var admin in admins)
            {
                if (admin.Username == u && admin.Password == p)
                {
                    admin.LoginDate = DateTime.Now;
                    Console.WriteLine("Login Successful!");
                    System.Threading.Thread.Sleep(1000);
                    return true;
                }
            }
            Console.WriteLine("Invalid Credentials. Press Enter to return.");
            Console.ReadLine();
            return false;
        }

        private void ShowAdminMenu()
        {
            bool inAdmin = true;
            while (inAdmin)
            {
                Console.Clear();
                Console.WriteLine("--- Admin Menu ---");
                Console.WriteLine("1. View All Quizzes");
                Console.WriteLine("2. View All Users");
                Console.WriteLine("3. Save Quizzes to CSV");
                Console.WriteLine("4. Logout");
                Console.Write("Enter choice: ");

                try
                {
                    int choice = int.Parse(Console.ReadLine());
                    switch (choice)
                    {
                        case 1:
                            foreach(var q in quizzes)
                            {
                                Console.WriteLine($"ID: {q.QuizID} | Title: {q.QuizTitle} | Category: {q.QuizCategory.CategoryName}");
                                Console.WriteLine($"   Questions Count: {q.Questions.Count}");
                            }
                            Console.WriteLine("Press Enter...");
                            Console.ReadLine();
                            break;
                        case 2:
                            Console.WriteLine("Admins:");
                            foreach (var a in admins) Console.WriteLine($"- {a.Username}");
                            Console.WriteLine("Students:");
                            foreach (var s in students) Console.WriteLine($"- {s.Username} ({s.Status})");
                            Console.WriteLine("Press Enter...");
                            Console.ReadLine();
                            break;
                        case 3:
                            SaveQuizToCSV();
                            break;
                        case 4:
                            inAdmin = false;
                            break;
                        default:
                            Console.WriteLine("Invalid.");
                            break;
                    }
                }
                catch { Console.WriteLine("Invalid Input."); Console.ReadLine(); }
            }
        }

        private void ShowStudentMenu()
        {
            // Per requirements: Student selects category then quiz
            Console.Clear();
            Console.WriteLine("--- Student Menu ---");
            Console.WriteLine("Available Categories:");
            foreach(var cat in categories)
            {
                Console.WriteLine(cat.GetCategoryInfo());
            }

            Console.WriteLine("\nAvailable Quizzes:");
            for (int i = 0; i < quizzes.Count; i++)
            {
                Console.WriteLine($"{i + 1}. {quizzes[i].QuizTitle} ({quizzes[i].QuizCategory.CategoryName})");
            }
            Console.WriteLine("0. Go Back");
            Console.Write("Select a Quiz number to play: ");

            try
            {
                int qIndex = int.Parse(Console.ReadLine()) - 1;
                if(qIndex == -1) return;

                if (qIndex >= 0 && qIndex < quizzes.Count)
                {
                    PlayQuiz(quizzes[qIndex]);
                }
                else
                {
                    Console.WriteLine("Invalid selection.");
                    Console.ReadLine();
                }
            }
            catch
            {
                Console.WriteLine("Invalid input.");
                Console.ReadLine();
            }
        }

        public void PlayQuiz(Quiz quiz)
        {
            int score = 0;
            Console.Clear();
            Console.WriteLine($"Starting Quiz: {quiz.QuizTitle}");
            Console.WriteLine(quiz.QuizDescription);
            Console.WriteLine("-----------------------------");

            foreach (var q in quiz.Questions)
            {
                Console.WriteLine($"\nQ: {q.QuestionText} (Difficulty: {q.DifficultyLevel})");
                for (int i = 0; i < q.QuestionOptions.Count; i++)
                {
                    Console.WriteLine($"{i + 1}. {q.QuestionOptions[i]}");
                }

                Console.Write("Type the answer exactly as shown: ");
                string answer = Console.ReadLine();

                if (q.ValidateAnswer(answer))
                {
                    Console.WriteLine("Correct!");
                    score++;
                }
                else
                {
                    Console.WriteLine($"Wrong! Correct answer: {q.CorrectAnswer}");
                }
            }

            Console.WriteLine($"\nQuiz Finished! You scored {score} out of {quiz.Questions.Count}.");
            Console.WriteLine("Press Enter to return to menu...");
            Console.ReadLine();
        }

        public void SaveQuizToCSV()
        {
            try
            {
                // Logic to save quizzes to questions.csv
                string filePath = "questions.csv";
                using (StreamWriter sw = new StreamWriter(filePath))
                {
                    sw.WriteLine("QuizID,QuizTitle,Category,QuestionID,QuestionText,CorrectAnswer");
                    foreach (var quiz in quizzes)
                    {
                        foreach (var q in quiz.Questions)
                        {
                            sw.WriteLine($"{quiz.QuizID},{quiz.QuizTitle},{quiz.QuizCategory.CategoryName},{q.QuestionID},{q.QuestionText},{q.CorrectAnswer}");
                        }
                    }
                }
                Console.WriteLine($"Successfully saved data to {filePath}");
                Console.ReadLine();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error saving to CSV: {ex.Message}");
                Console.ReadLine();
            }
        }

        public void Exit()
        {
            Console.WriteLine("Exiting Application. Goodbye!");
        }
    }
}
